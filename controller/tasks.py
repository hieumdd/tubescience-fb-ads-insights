import os
import json
import uuid

from google.cloud import tasks_v2
from google import auth

_, PROJECT_ID = auth.default()
TASKS_CLIENT = tasks_v2.CloudTasksClient()

TABLES = [
    "AdsInsights",
    "VideoInsights",
]

ACCOUNTS = [
    "1747490262138666",
    "3863802906447",
    "2826795090925144",
    "2469321280063553",
    "2441095352866922",
    "224800778174189",
    "999827036824519",
    "107231282794361",
    "542163415992887",
    "1620113241414678",
    "2450093448412095",
    "21475358",
    "2975326515886538",
    "1593101940714946",
    "1846973575327780",
    "974495872636652",
    "2122590364734731",
    "228864947998439",
    "1747608248723796",
    "554350994969724",
    "534707407373446",
    "1055175521605003",
    "10102767659534969",
    "787472891724965",
    "267544913961389",
    "269585950412753",
    "850397235748974",
    "1949222055320721",
    "821441204654913",
    "799064240225943",
    "10155603911388373",
    "10155298978278373",
    "171311423582237",
    "151390555495677",
    "931643893553428",
    "2073906195957960",
    "486123722185128",
    "293229431826316",
    "1132145507164475",
    "565310461025287",
    "688688725020204",
    "431428104314510",
    "365964814599154",
    "204672280381775",
    "1353066474788487",
    "770154516413022",
    "1480903842004749",
    "1381496801945454",
    "975894219172383",
    "778541725626218",
    "971805392966516",
    "1851620621567208",
    "1881107678600616",
    "1244202448957812",
    "1940963632615020",
    "1822080087836709",
    "1824540907590627",
    "1824539784257406",
    "1415072321967680",
    "419877745531328",
    "477369876364866",
    "444541076374865",
    "291409338412128",
    "2490264904329072",
    "1271367686360017",
    "749657595491383",
    "523463925057723",
    "2297281490537035",
    "1262883567205066",
    "490299401783142",
    "2671610552893113",
    "2432892620372875",
    "10105168",
    "485342304981701",
    "363248104470475",
    "776066752575920",
    "309287155913038",
    "267421560837596",
    "2050021318447381",
    "2101585763473732",
    "152900641498413",
    "2651653758184576",
    "1550063471716075",
    "2102008593353224",
    "1503463316533389",
    "336262913664636",
    "10158810768555508",
    "1381240942154664",
    "3635858869782761",
    "1273660049448268",
    "408829937124026",
    "1195641163801544",
    "615390636074257",
    "920016725156034",
    "2493883207560976",
    "246311679373354",
    "1223529531023664",
    "1252697341443995",
    "328072244639587",
    "356631748425423",
    "1345356512266795",
    "454769095197055",
    "580251625868702",
    "2465796217019913",
    "467322124170543",
    "1576635752489340",
    "611277952538796",
    "1028145947312439",
    "107342806058637",
    "512746932198556",
    "837931263323907",
    "769603890495531",
    # Nov 12
    "799415877133307",
    "394324714526845",
    "645849039360383",
    "1357916894374051",
    "10153034389398220",
    # Nov 17
    "780837282692243",
    # Nov 27
    "727453540732394",
    "771866136927840",
    "837434766619375",
    "1153252391355460",
]

CLOUD_TASKS_PATH = (PROJECT_ID, "us-central1", "fb-ads-insights")
PARENT = TASKS_CLIENT.queue_path(*CLOUD_TASKS_PATH)


def create_tasks(tasks_data: dict) -> dict:
    payloads = [
        {
            "name": f"{account}-{uuid.uuid4()}",
            "payload": {
                "table": tasks_data["table"],
                "ads_account_id": account,
                "start": tasks_data.get("start"),
                "end": tasks_data.get("end"),
            },
        }
        for account in ACCOUNTS
    ]
    tasks = [
        {
            "name": TASKS_CLIENT.task_path(
                *CLOUD_TASKS_PATH,
                task=str(payload["name"]),
            ),
            "http_request": {
                "http_method": tasks_v2.HttpMethod.POST,
                "url": os.getenv("PUBLIC_URL"),
                "oidc_token": {
                    "service_account_email": os.getenv('GCP_SA'),
                },
                "headers": {"Content-type": "application/json"},
                "body": json.dumps(payload["payload"]).encode(),
            },
        }
        for payload in payloads
    ]
    return {
        "tasks": len(
            [
                TASKS_CLIENT.create_task(
                    request={
                        "parent": PARENT,
                        "task": task,
                    }
                )
                for task in tasks
            ]
        ),
        "tasks_data": tasks_data,
    }
